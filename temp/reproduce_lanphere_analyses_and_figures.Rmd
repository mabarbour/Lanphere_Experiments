---
title: "reproduce_lanphere_analyses"
author: "Matt Barbour"
date: "May 9, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
## LOAD REQUIRED LIBRARIES ---- 

library(tidyverse)
library(brms)
library(rstan)
library(broom)
library(parallel)
library(cowplot)
library(stringr)


## SET OPTIONS TO SPEED UP BAYESIAN MODELS ----

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

```

```{r}
## WIND TRAIT DATA ----

w.trait.df <- read.csv('final_data/wind_trait_df.csv') %>% tbl_df() %>% mutate(Block = as.factor(Block), Plot_code = paste(Block, Wind.Exposure, sep="_"))

w.trait.2012 <- filter(w.trait.df, Year=="2012") %>%
  mutate(sc.Wind.Exposure = scale(as.numeric(Wind.Exposure)),
         sc.Trait.PC1 = scale(trait.PC1),
         trans.trait.PC2 = trait.PC2-min(trait.PC2)+1,          # make positive to enable log-transformation
         sc.log.trans.Trait.PC2 = scale(log(trans.trait.PC2)))  # log-transform to normalize prior to scaling

w.trait.2013 <- filter(w.trait.df, Year=="2013") %>%
  mutate(sc.Wind.Exposure = scale(as.numeric(Wind.Exposure)),
         sc.Trait.PC1 = scale(trait.PC1),
         sc.Trait.PC2 = scale(trait.PC2),
         sc.log.Root.CN = scale(log(root_CN)))                  # log-transform to normalize prior to scaling


## ANT-APHID TRAIT DATA ----

aa.trait.df <- read.csv('final_data/ant_aphid_trait_df.csv') %>% tbl_df() %>% mutate(Block=as.factor(Block), Plot_code=paste(Block, Ant.mound.dist, sep="_"))

aa.trait.2012 <- filter(aa.trait.df, Year=="2012") %>%
  mutate(sc.Aphid.treatment = scale(as.numeric(Aphid.treatment)),
         sc.Ant.mound.dist=scale(Ant.mound.dist),
         sc.Trait.PC1 = scale(trait.PC1),
         sc.Trait.PC2 = scale(trait.PC2))


## ANT-APHID ARTHROPOD COMMUNITY DATA ----

aa.arth.df <- read.csv('final_data/ant_aphid_arthropod_df.csv') %>% tbl_df() %>% 
  mutate(Block = as.factor(Block), 
         sc.Aphid.treatment=scale(as.numeric(Aphid.treatment)),
         sc.Ant.mound.dist=scale(Ant.mound.dist),
         sc.log1.Arthropod.Rich = scale(log(total.rich+1)))          # log(x+1) to normalize prior to scaling


## WIND ARTHROPOD COMMUNITY DATA ----

wind.arth.df <- read.csv('final_data/wind_arthropod_df.csv') %>% tbl_df() %>% mutate(Block = as.factor(Block), Plot_code = interaction(Block, Wind.Exposure))          

w.arth.2012 <- wind.arth.df %>% filter(Year == "2012") %>%
  mutate(sc.Wind.Exposure = scale(as.numeric(Wind.Exposure)),
         sc.log1.Arthropod.Rich = scale(log(total.rich+1)))         # log(x+1) to normalize prior to scaling

w.arth.2013 <- wind.arth.df %>% filter(Year == "2013") %>%
  mutate(sc.Wind.Exposure = scale(as.numeric(Wind.Exposure)),
         sc.log1.Arthropod.Rich = scale(log(total.rich+1)))         # log(x+1) to normalize prior to scaling


## WIND FUNGAL COMMUNITY DATA ----

fungal.df <- read.csv("final_data/fungal.df.csv") %>% tbl_df() %>% 
  mutate(Block = as.factor(Block),
         sc.Wind.Exposure = scale(as.numeric(Wind.Exposure)),
         sc.Fungi.Rarerich = scale(fungal.rarerich))


## WIND BACTERIA COMMUNITY DATA ----

bacteria.df <- read.csv("final_data/bacteria.df.csv") %>% tbl_df() %>% 
  mutate(Block = as.factor(Block), 
         sc.Wind.Exposure = scale(as.numeric(Wind.Exposure)),
         sc.Bacteria.Rarerich = scale(bacteria.rarerich))


## CORRELATION BETWEEN ABOVE AND BELOWGROUND RICHNESS ----

corr.data <- left_join(select(w.arth.2013, plant_ID, sc.log1.Arthropod.Rich), select(fungal.df, plant_ID, sc.Fungi.Rarerich)) %>%
  left_join(., select(bacteria.df, plant_ID, sc.Bacteria.Rarerich))
cor.test(x=corr.data$sc.log1.Arthropod.Rich, y=corr.data$sc.Fungi.Rarerich)
cor.test(x=corr.data$sc.log1.Arthropod.Rich, y=corr.data$sc.Bacteria.Rarerich)
cor.test(x=corr.data$sc.Bacteria.Rarerich, y=corr.data$sc.Fungi.Rarerich)
```

```{r}
## GENERAL FUNCTION FOR BAYESIAN LINEAR MIXED-EFFECTS MODELS ----

general_brm <- function(formula, family, data, ...) {
  brm(formula=formula, data=data, family=gaussian(link="identity"), 
      prior=c(prior(normal(0,1), class=b),
              prior(normal(0,1), class=sd)),
      control=list(adapt_delta=0.99),
      chains=4)
  # all other brm parameters correspond to the defaults
}

## GET POSTERIOR DISTRIBUTIONS OF STANDARD DEVIATIONS FOR FIXED & RANDOM EFFECTS ----
# uses methods of Nakagawa & Schielzeth, 2012 (Methods in Ecology & Evolution)

posterior_SDs <- function(brm_model, df, FE_formula){
  Fixed_Effects <- posterior_samples(brm_model, pars = "^b")
  sample_size <- dim(Fixed_Effects)[1]
  
  get_model_matrix <- model.matrix(as.formula(FE_formula), data=df)
  
  model_size <- dim(get_model_matrix)[2]
  
  FE_SD_list <- list()
  for(i in 1:model_size){
    FE_SD_vector <- c()
    for(j in 1:sample_size){
      FE_SD_vector[j] <- sd(as.vector(Fixed_Effects[j,i] * t(get_model_matrix)[i, ]))
    }
    FE_SD_list[[i]] <- FE_SD_vector
  }
  FE_SD_df <- as.data.frame(FE_SD_list)
  colnames(FE_SD_df) <- gsub("b_", "sd_", colnames(Fixed_Effects))
  
  SD_df <- data.frame(sample = 1:4000,
                      FE_SD_df,                                         # fixed effects
                      posterior_samples(brm_model, pars = "^sd"),       # random effects
                      posterior_samples(brm_model, pars = "sigma"))     # residual variance  
  return(SD_df)
}
```

```{r}
## ANT-APHID TRAIT-ARTHROPOD 2012 ANALYSIS ----

aa.trait.arth.2012 <- left_join(aa.arth.df, select(aa.trait.2012, plant_ID, sc.Trait.PC1, sc.Trait.PC2), by="plant_ID") %>%
  mutate(fact.Ant.mound.dist = factor(Ant.mound.dist))

trait.rich.aa.2012.brm <- general_brm(sc.log1.Arthropod.Rich~sc.Trait.PC1+sc.Trait.PC2+sc.Aphid.treatment*sc.Ant.mound.dist+(1+sc.Aphid.treatment*sc.Ant.mound.dist|Genotype)+(1|Block)+(1|Plot_code), data=aa.trait.arth.2012)
summary(trait.rich.aa.2012.brm) # trait.PC1 is key driver, but there is also a weak effect of trait.PC2

trait.rich.aa.12 <- posterior_samples(trait.rich.aa.2012.brm, pars = "^b") # data for plotting
```

